services:
  api-gateway:
    build: ./api-gateway
    ports:
      - "3000:3000"
    env_file:
      - ./api-gateway/config.env
      - ./api-gateway/secret.env
    depends_on:
      # - redis
      - identity-service 
      - post-service     
      - media-service    
      - search-service
      # - rabbitmq 
    # environment:
      # - REDIS_URL=redis://redis:6379
      # - RABBITMQ_URL=amqp://rabbitmq:5672 
    volumes:
      - ./api-gateway:/usr/src/app
      - /usr/src/app/node_modules
    command: npm run dev

  identity-service:
    build: ./identity-service
    env_file:
      - ./identity-service/config.env
      - ./identity-service/secret.env
    # depends_on:
      # - redis
      # - rabbitmq 
    # environment:
      # - REDIS_URL=redis://redis:6379
      # - RABBITMQ_URL=amqp://rabbitmq:5672 
    volumes:
      - ./identity-service:/usr/src/app
      - /usr/src/app/node_modules
    command: npm run dev

  post-service:
    build: ./post-service
    env_file:
      - ./post-service/config.env
      - ./post-service/secret.env
    depends_on:
      # - redis
      # - rabbitmq 
      - pubsub-emulator 
      - pubsub-setup
    environment:
      - PUBSUB_EMULATOR_HOST=pubsub-emulator:8085
      - GCP_PROJECT_ID=notional-cocoa-470007-p5
      # - REDIS_URL=redis://redis:6379
      # - RABBITMQ_URL=amqp://rabbitmq:5672 
    volumes:
      - ./post-service:/usr/src/app
      - /usr/src/app/node_modules
    command: sh -c "npm install && npm run dev"

  media-service:
    build: ./media-service
    env_file:
      - ./media-service/config.env
      - ./media-service/secret.env
    depends_on:
      # - redis
      # - rabbitmq 
      - pubsub-emulator
      - pubsub-setup 
    environment:
      - PUBSUB_EMULATOR_HOST=pubsub-emulator:8085
      - GCP_PROJECT_ID=notional-cocoa-470007-p5
      # - REDIS_URL=redis://redis:6379
      # - RABBITMQ_URL=amqp://rabbitmq:5672 
    volumes:
      - ./media-service:/usr/src/app
      - /usr/src/app/node_modules
    command: sh -c "npm install && npm run dev"

  search-service:
    build: ./search-service
    env_file:
      - ./search-service/config.env
      - ./search-service/secret.env
    depends_on:
      # - redis
      # - rabbitmq 
      - pubsub-emulator 
      - pubsub-setup
    environment:
      - PUBSUB_EMULATOR_HOST=pubsub-emulator:8085
      - GCP_PROJECT_ID=notional-cocoa-470007-p5
      # - REDIS_URL=redis://redis:6379
      # - RABBITMQ_URL=amqp://rabbitmq:5672 
    volumes:
      - ./search-service:/usr/src/app
      - /usr/src/app/node_modules
    command: sh -c "npm install && npm run dev"

  pubsub-emulator:
    image: gcr.io/google.com/cloudsdktool/google-cloud-cli
    command: >
      gcloud beta emulators pubsub start 
      --project=notional-cocoa-470007-p5 
      --host-port=0.0.0.0:8085
    ports:
      - "8085:8085"
  pubsub-setup:
    image: appropriate/curl # A tiny 6MB image for pusub emulater
    command: >
      sh -c "
        set -e;
        echo 'Waiting for Pub/Sub emulator...';
        until curl -s http://pubsub-emulator:8085 | grep -q 'Ok'; do
          echo 'Emulator not ready... sleeping 1s';
          sleep 1;
        done;
        echo 'Emulator is READY!';
        
        echo 'Creating topic: facebook-events-topic';
        curl -X PUT http://pubsub-emulator:8085/v1/projects/notional-cocoa-470007-p5/topics/facebook-events-topic;
        
        echo 'Creating subscription: media-service-subscription';
        curl -X PUT http://pubsub-emulator:8085/v1/projects/notional-cocoa-470007-p5/subscriptions/media-service-subscription -H 'Content-Type: application/json' -d '{\"topic\": \"projects/notional-cocoa-470007-p5/topics/facebook-events-topic\"}';
        
        echo 'Creating subscription: search-service-subscription';
        curl -X PUT http://pubsub-emulator:8085/v1/projects/notional-cocoa-470007-p5/subscriptions/search-service-subscription -H 'Content-Type: application/json' -d '{\"topic\": \"projects/notional-cocoa-470007-p5/topics/facebook-events-topic\"}';

        echo 'Pub/Sub setup is 100% complete!';
      "
    depends_on:
      - pubsub-emulator

  # rabbitmq:
  #   image: rabbitmq:3-management
  #   ports:
  #     - "5672:5672"
  #     - "15672:15672"
  #   healthcheck:
  #     test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 5
  # redis:
  #   image: redis:alpine
  #   ports:
  #     - "6379:6379"